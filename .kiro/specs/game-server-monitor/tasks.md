# Implementation Plan: 游戏服务器监控面板

## Overview

本实现计划将构建一个嵌入式的游戏服务器监控面板，前端 React 应用将被编译并嵌入到 Go 可执行文件中，形成单一的部署单元。实现将按照后端核心功能 → 前端基础 → 集成测试的顺序进行，确保每个步骤都有可验证的功能。

## Tasks

- [x] 1. 设置项目结构和核心依赖
  - 创建 Go 模块和基本目录结构
  - 设置前端 React + TypeScript 项目
  - 配置构建脚本和嵌入式资源
  - _Requirements: 6.1_

- [x] 2. 实现数据库层和模型
  - [x] 2.1 创建数据库模型和迁移
    - 定义 Server 和 User 结构体
    - 实现 GORM 数据库连接和自动迁移
    - _Requirements: 6.1, 6.4_

  - [ ]* 2.2 编写数据模型属性测试
    - **Property 17: 数据持久化一致性**
    - **Validates: Requirements 6.1, 6.2, 6.3, 6.4**

  - [x] 2.3 实现数据库操作接口
    - 创建服务器 CRUD 操作
    - 实现用户认证相关数据操作
    - _Requirements: 5.1, 5.3, 5.4_

  - [ ]* 2.4 编写数据库操作属性测试
    - **Property 15: 数据库操作一致性**
    - **Validates: Requirements 5.1, 5.3, 5.4**

- [x] 3. 实现服务器协议探测器
  - [x] 3.1 实现 Minecraft 协议探测
    - 集成 mcutils 库实现 Minecraft Query
    - 解析服务器状态、玩家数量、版本信息
    - _Requirements: 3.1, 3.3_

  - [x] 3.2 实现 CS2/Source Query 协议探测
    - 集成 go-a2s 库实现 Source Query
    - 解析 CS2 服务器状态和玩家信息
    - _Requirements: 3.2, 3.3_

  - [ ]* 3.3 编写协议探测属性测试
    - **Property 8: 协议探测正确性**
    - **Validates: Requirements 3.1, 3.2, 3.3**

  - [x] 3.4 实现探测器错误处理和离线检测
    - 处理网络超时和连接失败
    - 实现重试机制和离线状态标记
    - _Requirements: 3.4_

  - [ ]* 3.5 编写离线检测属性测试
    - **Property 9: 离线检测准确性**
    - **Validates: Requirements 3.4**

- [x] 4. 实现缓存系统和后台探测
  - [x] 4.1 创建内存缓存管理器
    - 实现线程安全的状态缓存
    - 支持 TTL 和过期清理
    - _Requirements: 6.5, 8.2_

  - [x] 4.2 实现后台定时探测任务
    - 创建独立 goroutine 执行定时探测
    - 实现探测间隔配置和任务调度
    - _Requirements: 3.5, 8.1, 8.4_

  - [ ]* 4.3 编写缓存和探测属性测试
    - **Property 18: 缓存机制有效性**
    - **Property 21: 后台探测独立性**
    - **Property 22: 探测间隔配置性**
    - **Validates: Requirements 6.5, 8.1, 8.2, 8.4**

- [x] 5. 实现 JWT 认证系统
  - [x] 5.1 创建 JWT 认证中间件
    - 实现 token 生成、验证和过期处理
    - 创建认证中间件保护管理接口
    - _Requirements: 4.1, 4.2, 4.4, 4.5_

  - [x] 5.2 实现登录接口和用户管理
    - 创建登录 API 和密码验证
    - 实现用户创建和管理功能
    - _Requirements: 4.2, 4.3_

  - [ ]* 5.3 编写认证系统属性测试
    - **Property 11: 认证访问控制**
    - **Property 12: JWT 认证流程**
    - **Property 13: Token 过期处理**
    - **Property 14: 管理接口保护**
    - **Validates: Requirements 4.1, 4.2, 4.3, 4.4, 4.5**

- [x] 6. 实现 API 接口层
  - [x] 6.1 创建公共 API 接口
    - 实现服务器列表和详情接口
    - 集成缓存系统返回实时状态
    - _Requirements: 1.1, 1.2, 2.1, 2.2_

  - [x] 6.2 创建管理 API 接口
    - 实现服务器配置的增删改查
    - 添加输入验证和错误处理
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ]* 6.3 编写输入验证属性测试
    - **Property 16: 输入验证完整性**
    - **Validates: Requirements 5.2, 5.5**

  - [x] 6.4 实现静态文件服务和 SPA 支持
    - 配置嵌入式前端资源服务
    - 实现 SPA 路由回退机制
    - _Requirements: 部署需求_

- [ ] 7. Checkpoint - 后端核心功能验证
  - 确保所有 API 接口正常工作，数据库操作正确，探测功能运行
  - 验证认证系统和缓存机制
  - 如有问题请询问用户

- [ ] 8. 实现前端状态管理
  - [ ] 8.1 创建 Zustand 状态存储
    - 实现 ServerStore 管理服务器数据
    - 实现 AuthStore 管理认证状态
    - 实现 AdminStore 管理后台操作
    - _Requirements: 1.1, 4.1_

  - [ ] 8.2 实现 API 客户端服务
    - 创建 Axios 配置和请求拦截器
    - 实现自动 token 刷新和错误处理
    - _Requirements: 1.1, 4.4_

  - [ ]* 8.3 编写状态管理单元测试
    - 测试状态更新和 API 集成
    - 验证错误处理和重试机制

- [ ] 9. 实现前端核心组件
  - [ ] 9.1 创建服务器卡片组件
    - 实现状态指示器和玩家数量显示
    - 添加响应式设计和交互效果
    - _Requirements: 1.2, 1.3, 1.4, 7.3, 7.4_

  - [ ] 9.2 创建服务器详情页面
    - 实现详情信息展示和 Markdown 渲染
    - 添加条件下载按钮显示
    - _Requirements: 2.2, 2.3, 2.4_

  - [ ]* 9.3 编写 UI 组件属性测试
    - **Property 2: 状态指示器一致性**
    - **Property 6: 条件渲染一致性**
    - **Property 7: Markdown 渲染正确性**
    - **Property 20: 状态可视化一致性**
    - **Validates: Requirements 1.3, 1.4, 2.3, 2.4, 7.3, 7.4**

- [ ] 10. 实现前端页面和路由
  - [ ] 10.1 创建主页面和服务器列表
    - 实现响应式网格布局
    - 添加自动刷新和加载状态
    - _Requirements: 1.1, 1.5, 7.1, 7.2_

  - [ ] 10.2 创建管理后台页面
    - 实现服务器配置表单和列表
    - 添加认证保护和权限验证
    - _Requirements: 4.1, 5.1, 5.2, 5.3, 5.4_

  - [ ] 10.3 实现路由配置和导航
    - 配置 React Router 和路由保护
    - 实现页面间导航和状态保持
    - _Requirements: 2.1, 4.1_

  - [ ]* 10.4 编写页面功能属性测试
    - **Property 1: 服务器列表完整性**
    - **Property 4: 导航一致性**
    - **Property 5: 详情页面完整性**
    - **Property 19: 响应式布局适应性**
    - **Validates: Requirements 1.1, 1.2, 2.1, 2.2, 7.1, 7.2**

- [ ] 11. 实现自动刷新和实时更新
  - [ ] 11.1 添加前端定时刷新机制
    - 实现状态自动刷新和用户交互
    - 处理网络错误和重连逻辑
    - _Requirements: 1.5, 8.3_

  - [ ]* 11.2 编写自动刷新属性测试
    - **Property 3: 自动刷新周期性**
    - **Property 23: 状态更新及时性**
    - **Validates: Requirements 1.5, 8.3**

- [ ] 12. 构建系统和嵌入式部署
  - [ ] 12.1 配置前端构建流程
    - 设置 Vite 生产构建配置
    - 优化资源打包和压缩
    - _Requirements: 部署需求_

  - [ ] 12.2 实现 Go embed 集成
    - 配置 embed 指令和构建脚本
    - 测试嵌入式资源加载
    - _Requirements: 部署需求_

  - [ ] 12.3 创建部署脚本和文档
    - 编写自动化构建脚本
    - 创建部署和配置说明
    - _Requirements: 部署需求_

- [ ] 13. 集成测试和性能优化
  - [ ]* 13.1 编写端到端集成测试
    - 测试完整的用户流程
    - 验证前后端集成正确性

  - [ ] 13.2 性能优化和错误处理完善
    - 优化数据库查询和缓存策略
    - 完善错误处理和用户体验
    - _Requirements: 8.5_

  - [ ]* 13.3 编写性能和错误处理属性测试
    - **Property 10: 非阻塞探测**
    - **Validates: Requirements 3.5**

- [ ] 14. 最终验证和文档
  - 确保所有功能正常工作，性能满足要求
  - 验证单一可执行文件部署
  - 完成用户文档和 API 文档

## Notes

- 任务标记 `*` 的为可选任务，可跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以确保可追溯性
- Checkpoint 任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 前端将构建为静态资源并嵌入到 Go 二进制文件中